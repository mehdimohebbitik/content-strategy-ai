from flask import Flask, request, jsonify, render_template
import google.generativeai as genai
import os

# ---- پیکربندی اولیه ----
app = Flask(__name__, template_folder='templates', static_folder='templates')

# کلید API هوش مصنوعی گوگل (Gemini) را اینجا قرار دهید
# امن‌ترین راه: این کلید را در متغیرهای محیطی سیستم (Environment Variables) ذخیره کنید
try:
    # os.environ['GOOGLE_API_KEY'] = 'YOUR_GOOGLE_API_KEY'
    genai.configure(api_key=os.environ.get("GOOGLE_API_KEY"))
    model = genai.GenerativeModel('gemini-pro')
except Exception as e:
    print(f"خطا در پیکربندی Gemini: {e}")
    model = None

# ---- تعریف پلی‌بوک محتوا ----
# !!! این بخش دقیقاً از روی متن شما کپی شده است !!!
CONTENT_PLAYBOOK = """
Playbook تولید محتوا

مرحله ۱: آماده‌سازی لیست دغدغه‌ها
مصاحبه با مشتریان، تحلیل کامنت‌ها و پیام‌ها، پایش ترندها، بررسی رقبا، همراهی کاربر در تجربه واقعی.

مرحله ۲: تکنیک و قالب سناریو
1) ریویو (Review)
تعریف: ارزیابی صادقانهٔ تجربه/محصول با مزایا و محدودیت‌ها.
فرمول سریع: زمینه → ۳ نکتهٔ مثبت → ۲ محدودیت → جمع‌بندی بی‌طرف.
2) داستان‌گویی (Storytelling)
تعریف: روایت مسئله تا دگرگونی، برای ایجاد همدلی و ماندگاری پیام.
فرمول سریع: وضعیت عادی → محرک → تعارض → تصمیم → نتیجه → نکتهٔ آموختنی.
3) تضاد (Contrast)
تعریف: برجسته‌کردن تفاوت دو رویکرد/نتیجهٔ متضاد.
فرمول سریع: حالت A (پیامد) ↔ حالت B (پیامد) → نکتهٔ کلیدی.
4) فهرست اقدام (To-Do)
تعریف: دستورالعمل کوتاه و اجرایی برای حل یک مسئله.
فرمول سریع: مشکل → ۳–۵ گام دقیق → نتیجهٔ قابل انتظار.
5) اتصال به موضوعات عمومی (Topical Connection / Newsjacking)
تعریف: ربط‌دادن پیام به ترند/خبر/مناسبت برای افزایش ارتباط و تازگی.
فرمول سریع: رخداد عمومی → پیوند با مسئلهٔ مخاطب → نکتهٔ کاربردی.
6) شخصیت فالگیر (Fortune-Teller Persona)
تعریف: پیش‌بینی دقیق درد مخاطب و پاسخ‌دادن قبل از پرسیده‌شدن.
فرمول سریع: «احتمالاً الان X را حس می‌کنی…» → علت پنهان → راه‌حل فوری.
7) مقایسه (Comparison)
تعریف: سنجش بی‌طرف A در برابر B با معیارهای ثابت.
فرمول سریع: معیارها (۳–۵ تا) → امتیازدهی/جدول → جمع‌بندی.
8) دوراهی (Dilemma)
تعریف: قرار دادن مخاطب میان دو مسیر با پیامدهای متفاوت برای روشن شدن ارزش‌ها.
فرمول سریع: گزینه ۱ (پیامد) ↔ گزینه 2 (پیامد) → معیار تصمیم.
9) مثال قابل‌نمایش (Show, Don’t Tell / Demo)
تعریف: به‌جای ادعا، نمونهٔ عینی نشان بده.
فرمول سریع: مسئله → دمو کوتاه → نتیجهٔ قبل/بعد.
10) همزادپنداری (Empathy / POV Shift)
تعریف: روایت از دید مخاطب برای همدلی و فهم دقیق نیاز.
فرمول سریع: «منِ مخاطب…» → احساس/مانع → راه‌حل مطابق محدودیت واقعی.
11) سه تا «اگر» (Three Ifs)
تعریف: پوشش سه سناریوی رایج با پاسخ مختصر.
فرمول سریع: اگر X… → راه‌حل A | اگر Y… → B | اگر Z… → C.
12) کار درست/غلط (Do & Don’t)
تعریف: تبیین سریع باید/نبایدها با نمونهٔ واقعی.
فرمول سریع: ۳ تا Do + ۳ تا Don’t → دلیل کوتاه.
13) هشدار (Warning)
تعریف: اشاره به ریسک رایج و راهٔ پیشگیری.
فرمول سریع: خطر پنهان → مثال ملموس → راه ایمن.
14) تعلیق (Suspense / Cliffhanger)
تعریف: نگه‌داشتن پاسخ یا نتیجه برای حفظ کنجکاوی.
فرمول سریع: سوال محرک → تأخیر آگاهانه → پاسخ/چرخش.
15) تصویر عجیب (Striking Visual / Odd Metaphor)
تعریف: تمثیل یا تصویر غیرمنتظره برای جلب توجه و تثبیت پیام.
فرمول سریع: تشبیه غافلگیرکننده → توضیح ارتباط → نکته.
16) حرفه‌ای/مبتدی (Pro vs Newbie)
تعریف: نشان دادن تفاوت فکر/رفتار حرفه‌ای با مبتدی.
فرمول سریع: مبتدی: رفتار/باور → پیامد | حرفه‌ای: رفتار/باور → پیامد.
17) اطلاعات زیاد در زمان کم (High-Density Info / Rapid-Fire)
تعریف: چک‌لیست فشردهٔ نکات پرارزش.
فرمول سریع: یک موضوع → ۷–۱۰ بولت تک‌خطی → گروه‌بندی هوشمند.
18) قلاب–پرداخت–حلقه (Hook–Payoff–Loop)
تعریف: شروع گیرا، تحویل ارزش سریع، و حلقه‌زدن برای تماشا/خواندن ادامه.
فرمول سریع: Hook (۳–۵ث) → Payoff (نتیجه/ترفند) → Loop (وعدهٔ بخش بعدی/پیوستگی).
19) افسانه‌زدایی (Myth-Busting)
تعریف: شکستن یک باور غلط و جایگزینی با اصل درست.
فرمول سریع: باور رایج → چرا غلط است (داده/منطق) → چه‌کار درست است.
20) خط زمانی (Timeline)
تعریف: روایت تغییر در طول زمان برای نمایش روند/تکامل.
فرمول سریع: قبل → نقطهٔ عطف ۱ → نقطهٔ عطف ۲ → امروز → قدم بعدی.
21) وقفهٔ الگو (Pattern Interrupt)
تعریف: شکستن ریتم/زاویه/قالب برای غافلگیری مثبت.
فرمول سریع: الگوی جاری → وقفهٔ ناگهانی (سوال/تصویر/زاویهٔ جدید) → بازگشت با پیام.
22) پشت‌صحنه (BTS: Behind The Scenes)
تعریف: نمایش روند واقعی، ابزارها، خطاها و درس‌ها برای افزایش اعتماد.
فرمول سریع: هدف → فرآیند واقعی → چالش → راه‌حل/نتیجه.
23) میکرو-آموزش (Micro-Tutorial)
تعریف: آموزش یک مهارت خرد در ۳۰–۶۰ ثانیه/چند خط.
فرمول سریع: مسئله → گام‌های ۱–۳ → نتیجهٔ فوری.
24) پشتهٔ اثبات (Proof Stack)
تعریف: لایه‌چینی شواهد برای تقویت ادعا.
فرمول سریع: ادعا → داده/نمونه → سوشال‌پروف/نظر کاربر → دمو کوتاه.
25) موافق/مخالف (Pros & Cons)
تعریف: نگاه دوسویه با معیارهای روشن و جمع‌بندی متوازن.
فرمول سریع: ۳–۵ مزیت | ۲–۴ عیب → بسته به شرایط چه کنیم.

مرحله ۳: فرم محتوا
ولاگ (Vlog), ویدئو‌کست (Vodcast), ویدئو کلیپ (Video Clip), مصاحبه (Interview Video), پرزنتیشن (Video Presentation), اسکرین‌ریکورد (Screen Recording), موشن‌گرافیک (Motion Graphics), POV, تایم‌لپس (Time-lapse), هایلایت لایو (Live Highlights), ری‌اکت (Reaction Video), انیمیشن تایپوگرافی (Kinetic Typography), اسلایدشو (Slideshow Video), اکسپلینر (Explainer Video), وایت‌بورد انیمیشن (Whiteboard Animation), آن‌باکسینگ (Unboxing).

مرحله ۴: دعوت به اقدام CTA
پسندیدن/واکنش (Like), نظر بده/پاسخ بده (Comment), ذخیره کن (Save), به‌اشتراک‌گذاری/ارسال به دوست (Share), دنبال کن/عضویت (Follow), نوتیف روشن کن (Turn on Notifications), تا آخر ببین (Watch till the End), ویدیوی بعدی/پلی‌لیست (Watch Next), کلیک روی لینک (Click the Link), بازدید از پروفایل (Visit Profile), پیام بده/تماس بگیر (DM), منشن/تگ کن (Tag a Friend), رأی بده/نظرسنجی (Vote), ریمیکس/دوئت (Remix), UGC با هشتگ, ثبت‌نام/عضویت (Sign Up), دانلود منبع (Download), شروع دورهٔ آزمایشی (Start Free Trial), خرید/سفارش (Buy Now), رزرو دمو/تماس (Book a Demo).
"""


@app.route('/')
def index():
    return render_template('index.html')

@app.route('/generate-concerns', methods=['POST'])
def generate_concerns():
    if not model:
        return jsonify({'error': 'مدل هوش مصنوعی پیکربندی نشده است.'}), 500
    try:
        brand_info = request.json
        
        prompt = f"""
        شما یک استراتژیست ارشد برند و تحلیلگر تحقیقات بازار هستید. بر اساس بریف استراتژی جامع برند که در ادامه آمده، ۵ تا ۷ مورد از مهم‌ترین دغدغه‌ها، چالش‌ها، یا سوالات بی‌پاسخ مخاطبان هدف (که در بخش پرسونا تعریف شده‌اند) را شناسایی و به صورت یک لیست شماره‌گذاری شده بنویسید. تحلیل شما باید عمیق، دقیق و مستقیماً از داده‌های ورودی نشأت گرفته باشد.

        بریف استراتژی برند:
        {brand_info}
        """
        
        response = model.generate_content(prompt)
        return jsonify({'concerns': response.text})
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/generate-scenario', methods=['POST'])
def generate_scenario():
    if not model:
        return jsonify({'error': 'مدل هوش مصنوعی پیکربندی نشده است.'}), 500
    try:
        data = request.json
        brand_info = data['brandInfo']
        concerns = data['concerns']

        prompt = f"""
        شما یک کارگردان خلاق و استراتژیست محتوای متخصص در ویدئوهای کوتاه برای شبکه‌های اجتماعی هستید. وظیفه شما تولید یک سناریوی کامل و آماده برای ساخت یک ویدئوی زیر ۶۰ ثانیه است.
        شما باید **دقیقاً** از پلی‌بوک و بریف زیر پیروی کنید.

        **بریف استراتژی برند:**
        {brand_info}

        **دغدغه‌های اصلی مخاطبان (که قبلاً شناسایی شده):**
        {concerns}

        **پلی‌بوک تولید محتوا (قوانین شما):**
        {CONTENT_PLAYBOOK}

        **دستورالعمل دقیق شما:**
        1.  **تحلیل عمیق:** بریف برند و دغدغه‌های مخاطب را به دقت تحلیل کن.
        2.  **انتخاب تکنیک:** از بین ۲۵ تکنیک در «مرحله ۲» پلی‌بوک، **یک** تکنیک را انتخاب کن که به بهترین شکل به یکی از دغدغه‌های کلیدی پاسخ می‌دهد.
        3.  **انتخاب فرم:** از «مرحله ۳» پلی‌بوک، **یک** فرم ویدئویی مناسب برای تکنیک انتخابی و شخصیت برند انتخاب کن.
        4.  **انتخاب CTA:** از «مرحله ۴» پلی‌بوک، **یک** دعوت به اقدام (CTA) اصلی را انتخاب کن که با اهداف (KPI) برند همسو باشد.
        5.  **نوشتن سناریو:** با ترکیب این سه عنصر، سناریوی نهایی را بنویس.

        **فرمت خروجی شما باید دقیقاً به شکل زیر باشد:**
        
        **عنوان پیشنهادی ویدئو:** [یک عنوان جذاب و کوتاه]
        
        **تکنیک انتخابی:** [نام تکنیک از لیست، مثلا: (19) افسانه‌زدایی (Myth-Busting)]
        
        **فرم انتخابی:** [نام فرم از لیست، مثلا: ویدئو کلیپ (Video Clip)]
        
        **CTA اصلی:** [نام CTA از لیست، مثلا: (3) ذخیره کن (Save for Later)]
        
        ---
        
        **شرح کامل سناریو:**
        
        **- قلاب (۳ ثانیه اول):** [شرح دقیق صحنه، دیالوگ یا متنی که توجه را جلب می‌کند.]
        
        **- بدنه اصلی (بر اساس فرمول تکنیک):** [شرح سکانس به سکانس ویدئو، شامل توضیحات بصری، دیالوگ‌ها، متن روی تصویر (On-screen text)، و پیشنهاد برای موسیقی یا افکت صوتی.]
        
        **- دعوت به اقدام (پایان ویدئو):** [شرح دقیق نحوه اجرای CTA در انتهای ویدئو.]

        ---
        حالا شروع کن.
        """

        response = model.generate_content(prompt)
        return jsonify({'scenario': response.text})

    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5001) # Use a different port to avoid conflicts
