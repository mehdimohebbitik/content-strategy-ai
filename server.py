from flask import Flask, request, jsonify, render_template
import google.generativeai as genai
import os
import traceback

# ---- پیکربندی اولیه ----
app = Flask(__name__, static_folder='static')

# ---- پیکربندی مدل هوش مصنوعی ----
model = None
try:
    api_key = os.environ.get("GOOGLE_API_KEY")
    if not api_key:
        print("خطا: متغیر محیطی GOOGLE_API_KEY پیدا نشد.")
    else:
        genai.configure(api_key=api_key)
        # استفاده از مدل پایدار و در دسترس
        model = genai.GenerativeModel("gemini-1.0-pro")
        print("مدل Gemini (با API Key) با موفقیت پیکربندی شد.")
except Exception as e:
    print(f"!!! خطا در هنگام پیکربندی Gemini: {e} !!!")
    traceback.print_exc()

# ---- پلی‌بوک محتوا ----
CONTENT_PLAYBOOK = """
Playbook تولید محتوا

مرحله ۱: آماده‌سازی لیست دغدغه‌ها
مصاحبه با مشتریان، تحلیل کامنت‌ها و پیام‌ها، پایش ترندها، بررسی رقبا، همراهی کاربر در تجربه واقعی.
مرحله ۲: تکنیک و قالب سناریو
1) ریویو (Review)
تعریف: ارزیابی صادقانهٔ تجربه/محصول با مزایا و محدودیت‌ها.
فرمول سریع: زمینه → ۳ نکتهٔ مثبت → ۲ محدودیت → جمع‌بندی بی‌طرف.
2) داستان‌گویی (Storytelling)
تعریف: روایت مسئله تا دگرگونی، برای ایجاد همدلی و ماندگاری پیام.
فرمول سریع: وضعیت عادی → محرک → تعارض → تصمیم → نتیجه → نکتهٔ آموختنی.
3) تضاد (Contrast)
تعریف: برجسته‌کردن تفاوت دو رویکرد/نتیجهٔ متضاد.
فرمول سریع: حالت A (پیامد) ↔ حالت B (پیامد) → نکتهٔ کلیدی.
4) فهرست اقدام (To-Do)
تعریف: دستورالعمل کوتاه و اجرایی برای حل یک مسئله.
فرمول سریع: مشکل → ۳–۵ گام دقیق → نتیجهٔ قابل انتظار.
5) اتصال به موضوعات عمومی (Topical Connection / Newsjacking)
تعریف: ربط‌دادن پیام به ترند/خبر/مناسبت برای افزایش ارتباط و تازگی.
فرمول سریع: رخداد عمومی → پیوند با مسئلهٔ مخاطب → نکتهٔ کاربردی.
6) شخصیت فالگیر (Fortune-Teller Persona)
تعریف: پیش‌بینی دقیق درد مخاطب و پاسخ‌دادن قبل از پرسیده‌شدن.
فرمول سریع: «احتمالاً الان X را حس می‌کنی…» → علت پنهان → راه‌حل فوری.
7) مقایسه (Comparison)
تعریف: سنجش بی‌طرف A در برابر B با معیارهای ثابت.
فرمول سریع: معیارها (۳–۵ تا) → امتیازدهی/جدول → جمع‌بندی.
8) دوراهی (Dilemma)
تعریف: قرار دادن مخاطب میان دو مسیر با پیامدهای متفاوت برای روشن شدن ارزش‌ها.
فرمول سریع: گزینه ۱ (پیامد) ↔ گزینه 2 (پیامد) → معیار تصمیم.
9) مثال قابل‌نمایش (Show, Don’t Tell / Demo)
تعریف: به‌جای ادعا، نمونهٔ عینی نشان بده.
فرمول سریع: مسئله → دمو کوتاه → نتیجهٔ قبل/بعد.
10) همزادپنداری (Empathy / POV Shift)
تعریف: روایت از دید مخاطب برای همدلی و فهم دقیق نیاز.
فرمول سریع: «منِ مخاطب…» → احساس/مانع → راه‌حل مطابق محدودیت واقعی.
11) سه تا «اگر» (Three Ifs)
تعریف: پوشش سه سناریوی رایج با پاسخ مختصر.
فرمول سریع: اگر X… → راه‌حل A | اگر Y… → B | اگر Z… → C.
12) کار درست/غلط (Do & Don’t)
تعریف: تبیین سریع باید/نبایدها با نمونهٔ واقعی.
فرمول سریع: ۳ تا Do + ۳ تا Don’t → دلیل کوتاه.
13) هشدار (Warning)
تعریف: اشاره به ریسک رایج و راهٔ پیشگیری.
فرمول سریع: خطر پنهان → مثال ملموس → راه ایمن.
14) تعلیق (Suspense / Cliffhanger)
تعریف: نگه‌داشتن پاسخ یا نتیجه برای حفظ کنجکاوی.
فرمول سریع: سوال محرک → تأخیر آگاهانه → پاسخ/چرخش.
15) تصویر عجیب (Striking Visual / Odd Metaphor)
تعریف: تمثیل یا تصویر غیرمنتظره برای جلب توجه و تثبیت پیام.
فرمول سریع: تشبیه غافلگیرکننده → توضیح ارتباط → نکته.
16) حرفه‌ای/مبتدی (Pro vs Newbie)
تعریف: نشان دادن تفاوت فکر/رفتار حرفه‌ای با مبتدی.
فرمول سریع: مبتدی: رفتار/باور → پیامد | حرفه‌ای: رفتار/باور → پیامد.
17) اطلاعات زیاد در زمان کم (High-Density Info / Rapid-Fire)
تعریف: چک‌لیست فشردهٔ نکات پرارزش.
فرمول سریع: یک موضوع → ۷–۱۰ بولت تک‌خطی → گروه‌بندی هوشمند.
18) قلاب–پرداخت–حلقه (Hook–Payoff–Loop)
تعریف: شروع گیرا، تحویل ارزش سریع، و حلقه‌زدن برای تماشا/خواندن ادامه.
فرمول سریع: Hook (۳–۵ث) → Payoff (نتیجه/ترفند) → Loop (وعدهٔ بخش بعدی/پیوستگی).
19) افسانه‌زدایی (Myth-Busting)
تعریف: شکستن یک باور غلط و جایگزینی با اصل درست.
فرمول سریع: باور رایج → چرا غلط است (داده/منطق) → چه‌کار درست است.
20) خط زمانی (Timeline)
تعریف: روایت تغییر در طول زمان برای نمایش روند/تکامل.
فرمول سریع: قبل → نقطهٔ عطف ۱ → نقطهٔ عطف ۲ → امروز → قدم بعدی.
21) وقفهٔ الگو (Pattern Interrupt)
تعریف: شکستن ریتم/زاویه/قالب برای غافلگیری مثبت.
فرمول سریع: الگوی جاری → وقفهٔ ناگهانی (سوال/تصویر/زاویهٔ جدید) → بازگشت با پیام.
22) پشت‌صحنه (BTS: Behind The Scenes)
تعریف: نمایش روند واقعی، ابزارها، خطاها و درس‌ها برای افزایش اعتماد.
فرمول سریع: هدف → فرآیند واقعی → چالش → راه‌حل/نتیجه.
23) میکرو-آموزش (Micro-Tutorial)
تعریف: آموزش یک مهارت خرد در ۳۰–۶۰ ثانیه/چند خط.
فرمول سریع: مسئله → گام‌های ۱–۳ → نتیجهٔ فوری.
24) پشتهٔ اثبات (Proof Stack)
تعریف: لایه‌چینی شواهد برای تقویت ادعا.
فرمول سریع: ادعا → داده/نمونه → سوشال‌پروف/نظر کاربر → دمو کوتاه.
25) موافق/مخالف (Pros & Cons)
تعریف: نگاه دوسویه با معیارهای روشن و جمع‌بندی متوازن.
فرمول سریع: ۳–۵ مزیت | ۲–۴ عیب → بسته به شرایط چه کنیم.
مرحله ۳: فرم محتوا
ولاگ (Vlog / Video Blog)
چیست؟ روایت شخصی جلوی دوربین؛ روزمره، پشت‌صحنه زندگی/کار، سفر، مسیر یادگیری و… . تمرکز روی «شخصیت و صدا»ی سازنده است. Adobe+1
مثال: «یک روز با منِ تدوین‌گر؛ از گرفتن بریف تا تحویل خروجی».
ویدئو‌کست / ویدئو پادکست (Vodcast / Video Podcast)
چیست؟ نسخه تصویری پادکست: گفت‌وگو/تک‌گویی اپیزودیک که شنیدنی است ولی با تصویر غنی‌تر می‌شود (نمای استودیو، نمایش منابع روی تصویر، B-roll). Podcastle+2Cambridge Dictionary+2
مثال: گفت‌وگوی ۳۰ دقیقه‌ای درباره «استراتژی محتوا» با مهمان؛ برش‌های ۳۰–۶۰ ثانیه‌ای برای شبکه‌های اجتماعی.
ویدئو کلیپ (Video Clip / Short-form Video)
چیست؟ قطعه ویدیویی کوتاه و سریع (اغلب عمودی)، معمولاً زیر ۶۰–۱۸۰ ثانیه؛ برای پیام‌های تک‌نکته‌ای، تیزر، میم، یا هایلایت. Wikipedia+1
مثال: ۴۵ ثانیه «۳ ترفند سریع برای افزایش ریتنشن».
مصاحبه (Interview Video)
چیست؟ گفت‌وگوی ساختارمند (یک‌به‌یک یا پنلی) با نور/صدا مناسب، گاهی با B-roll و کات‌اوی برای ریتم. (در لیست‌های «انواع ویدئو مارکتینگ» هم به‌عنوان فرمت جداگانه آمده است.) bluesquaremanagement.com
مثال: مصاحبه ۱۰ دقیقه‌ای با یک کارآفرین؛ سؤالات از پیش طراحی‌شده + اینسرت نمونه‌کارها.
پرزنتیشن (Video Presentation)
چیست؟ ارائه محتوای اسلایدی یا وایت‌بوردی به‌صورت ویدئو؛ مناسب آموزش/گزارش/پیشنهاد. Storydoc: Present. Engage. Win.
مثال: پرزنتیشن ۶ دقیقه‌ای «نتیجه تست A/B» با اسلاید و نریشن.
اسکرین‌ریکورد / اسکرین‌کست (Screen Recording / Screencast)
چیست؟ ضبط نمایشگر + نریشن برای آموزش اپ، دمو محصول، باگ ریپورت، یا راهنمای داخلی. TechSmith+1
مثال: آموزش ۵ دقیقه‌ای «چطور در CRM تیکت بسازیم».
موشن‌گرافیک (Motion Graphics)
چیست؟ طراحی گرافیک متحرک (لوگو، آیکون، نمودار، متن) برای توضیح، برندینگ یا اینفو موشن؛ با ابزارهایی مثل After Effects. Adobe+1
مثال: ویدئوی ۷۵ ثانیه‌ای معرفی ویژگی‌های جدید اپ با موشن آیکون‌ها.
POV / نمای نقطه‌دید (Point-of-View Shot/Video)
چیست؟ دوربین از زاویه دید شخص/کاراکتر ضبط می‌کند تا تجربه اول‌شخص بسازد (معمولاً با اکشن‌کم/موبایل). Wikipedia+1
مثال: «یک روز کاری از دید کافه‌دار»؛ دوربین روی سینه/سر.
تایم‌لپس (Time-lapse)
چیست؟ ثبت فریم‌ها با فواصل طولانی و پخش با فریم‌ریت عادی؛ حرکت زمان را تند و تغییرات آهسته را نمایان می‌کند. Wikipedia+1
مثال: ۲۰ ثانیه رشد چیدمان غرفه از صبح تا افتتاحیه.
هایلایت لایو (Live Highlights / Highlight Reel)
چیست؟ گزیده بهترین لحظات یک لایو/رویداد؛ تدوین فشرده برای مرور یا تیزر. Vimeo+1
مثال: ۶۰ ثانیه گلچین از پرسش‌های طلایی وبینار.
ری‌اکت (Reaction Video)
چیست؟ واکنش/تحلیلِ هم‌زمان سازنده به یک ویدئو/تریلر/خبر؛ اغلب تصویر منبع درون کادر نمایش داده می‌شود (مسائل کپی‌رایت را باید رعایت کرد). Wikipedia
مثال: واکنش تحلیلی به معرفی آیفون جدید با توقف و توضیح نکات کلیدی.
انیمیشن تایپوگرافی (Kinetic Typography / Animated Text)
چیست؟ بیان پیام با «متنِ متحرک» (اسکرول، پرش، تغییر شکل) برای تاکید ریتمیک و خواناییِ پویا. Wikipedia
مثال: ۳۰ ثانیه اسنک محتوایی «۳ اصل کپی‌نویسی» فقط با تایپو انیمیت‌شده.
اسلایدشو (Slideshow Video)
چیست؟ توالی تصاویر ثابت (با موزیک/نریشن) به شکل ویدئو؛ سبک‌وزن و سریع برای معرفی نمونه‌کار، آلبوم، یا کاتالوگ. Wikipedia
مثال: اسلایدشو ۴۵ ثانیه‌ای «قبل/بعد پروژه بازطراحی فروشگاه».
موشن‌گرافیک تایپو + گرافیک (ترکیبیِ 7 و 12)
چیست؟ وقتی تایپوگرافی متحرک با المان‌های گرافیکی/آیکونی ترکیب می‌شود (فرم محبوب برای «اکسپلینر»های کوتاه). StudioBinder
مثال: ویدئوی ۶۰ ثانیه‌ای «چطور الگوریتم ما کار می‌کند؟» با متن متحرک و نمودار موشن.
چند فرمِ مکملِ پرکاربرد (اختیاری ولی توصیه‌شده)
اکسپلینر (Explainer Video): توضیح ساده‌ی یک مفهوم/محصول در ۶۰–۱۸۰ ثانیه؛ غالباً موشن‌گرافیک یا لایواکشن+موشن. Vidico+2Wyzowl+2
وایت‌بورد انیمیشن (Whiteboard Animation): روایت تصویریِ دست‌به‌دست روی وایت‌بورد + نریشن. Wikipedia+1
۳۶۰/VR (360° / VR Video): تجربه تعاملی با دید ۳۶۰ درجه؛ مناسب تور مجازی/تجربه فضا. Google Help+1
لایو استریم (Live Streaming): پخش زنده با چت و تعامل لحظه‌ای (وبکم/موبایل/انکودر). Google Help+1
آن‌باکسینگ (Unboxing): باز کردن محصول در برابر دوربین + اولین برداشت‌ها. Wikipedia
اسکرین‌کست آموزشی کوتاه (Micro-Tutorial): آموزش ۳۰–۹۰ ثانیه‌ایِ یک مهارت خرد؛ اغلب عمودی. Vidico
مرحله ۴: دعوت به اقدام CTA
1) پسندیدن/واکنش (Like / React)
هدف: تعامل سریع، سیگنال اولیه به الگوریتم‌ها.
اصطکاک: کم | محل: داخل ویدئو، کپشن، استیکر پایان.
توضیح: ساده‌ترین درخواست؛ برای گرم‌کردن تعامل.
مثال‌ها:
«اگه مفید بود، لایک یادت نره!» | “If this helped, tap like!”
«با این ایموجی‌ها واکنش بده: 👍🔥❓» | “React with an emoji so I know you’re here!”
«اگه موافقی دوتا تپ بزن.» | “Double-tap if you agree.”
2) نظر بده/پاسخ بده (Comment / Answer the Question)
هدف: گفت‌وگو، جمع‌آوری Insight.
اصطکاک: کم–متوسط | محل: داخل ویدئو، کپشن، پینِ کامنت.
مثال‌ها:
«تو کدوم مرحله گیر می‌کنی؟ تو کامنت بنویس.» | “Where do you get stuck? Tell me in the comments.”
«بین A و B کدومو انتخاب می‌کنی؟ چرا؟» | “A vs B—which one and why?”
«یه نکتهٔ دیگه اضافه کن تا جمعش کنیم.» | “Add one tip we missed!”
3) ذخیره کن (Save for Later)
هدف: بازگشت/Retention، ارزش بلندمدت.
اصطکاک: کم | محل: داخل ویدئو/کپشن.
مثال‌ها:
«برای آخر هفته ذخیره‌اش کن.» | “Save this for the weekend.”
«وقتی اجراش کردی برگرد ببینش.» | “Save now, revisit when you try it.”
4) به‌اشتراک‌گذاری/ارسال به دوست (Share / Send to a Friend)
هدف: دسترسی ارگانیک، رشد.
اصطکاک: متوسط | محل: داخل ویدئو/کپشن/پایان.
مثال‌ها:
«برای هم‌تیمی‌ات بفرست تا باهم شروع کنید.» | “Share with a teammate to start together.”
«برای کسی که بهش نیاز داره بفرست.» | “Send this to someone who needs it.”
«تو گروهاتون فوروارد کنین.» | “Forward to your group chat.”
5) دنبال کن/عضویت (Follow / Subscribe)
هدف: ساخت جامعه و تکرار تماشا.
اصطکاک: کم–متوسط | محل: داخل ویدئو، انداسکرین یوتیوب (subscribe)، کپشن.
مثال‌ها:
«برای قسمت بعدی دنبال کن.» | “Follow for the next part.”
«سابسکرایب کن تا آموزش‌های هفتگی رو از دست ندی.» | “Subscribe to catch weekly tips.”
«هر روز یه هک جدید—فالو کن.» | “Daily hacks—hit follow.”
6) نوتیف روشن کن (Turn on Notifications / Bell)
هدف: دفعات بازگشت، Early views.
اصطکاک: متوسط | محل: داخل ویدئو/انداسکرین/کپشن.
مثال‌ها:
«زنگوله رو بزن تا موقع انتشار خبرت کنه.» | “Tap the bell so you’re notified.”
«پست‌های سریالی رو از دست نده—نوتیف روشنه؟» | “Don’t miss the series—turn on notifications.”
7) تا آخر ببین (Watch till the End)
هدف: افزایش Watch Time / Retention.
اصطکاک: کم | محل: ابتدای ویدئو، میانه (Loop)، کپشن.
مثال‌ها:
«آخرش یه چک‌لیست آماده می‌دم—تا آخر بمون.» | “Stay till the end for the checklist.”
«نتیجهٔ تست رو دقیقهٔ آخر می‌گم.» | “The result’s at the end—keep watching.”
8) ویدیوی بعدی/پلی‌لیست (Watch Next / Playlist / End Screen)
هدف: Session ادامه‌دار، عمق مصرف.
اصطکاک: متوسط | محل: انداسکرین/کارت/پین‌کامنت/کپشن.
نکتهٔ یوتیوب: انداسکرین در ۵–۲۰ ثانیهٔ پایانی؛ تا ۴ المان. Google Help+1
مثال‌ها:
«قسمت ۲ همین‌جا—بزن روی کارت.» | “Part 2 here—tap the card.”
«کل مسیر توی این پلی‌لیسته.» | “Binge the full playlist next.”
9) کلیک روی لینک (Click the Link: Bio/Description/Sticker)
هدف: ارجاع به منبع/لندینگ.
اصطکاک: متوسط | محل: کپشن/بیو/استوری-استیکر/توضیحات.
نکتهٔ ریلز: لینک مستقیم اغلب کلیک‌خور نیست؛ راه‌حل «Link in bio/ads». Workroom
مثال‌ها:
«لینک و فایل نمونه تو بیوئه.» | “Link + sample file in bio.”
“Full tutorial in the description—tap through.”
10) بازدید از پروفایل (Visit Profile)
هدف: آگاهی از برند، راهبری به Highlights/Links.
اصطکاک: کم–متوسط | محل: داخل ویدئو/کپشن/تامنیل.
مثال‌ها:
«برو پروفایل—هایلایت “Tools” رو باز کن.» | “Head to profile—open the ‘Tools’ highlight.”
“Profile has templates you can copy.”
11) پیام بده/تماس بگیر (DM / Contact)
هدف: گفت‌وگوی مستقیم، لید.
اصطکاک: متوسط–بالا | محل: داخل ویدئو/کپشن.
مثال‌ها:
«سوال داری؟ همین‌جا DM بده راهنمایی‌ت می‌کنیم.» | “Questions? DM us—we’ll help.”
«کلمهٔ «پلن» رو پیام بده تا پلن‌ها رو بفرستیم.» | “DM ‘PLAN’ to get our pricing.”
12) منشن/تگ کن (Tag a Friend)
هدف: کشف مخاطب شبیه، رشد ارگانیک.
اصطکاک: متوسط | محل: کپشن/داخل ویدئو.
مثال‌ها:
«کسی که باید ببینه رو تگ کن.» | “Tag someone who needs this.”
«دوستت که این مشکل رو داره منشنش کن.» | “Mention a friend who has this issue.”
13) رأی بده/نظرسنجی/کوییز (Vote / Poll / Quiz)
هدف: سنجش علاقه، دادهٔ تعاملی.
اصطکاک: کم | محل: استیکر، کپشن با سینتکس ساده (A/B).
مثال‌ها:
«رأی بده: نسخهٔ ۱ یا ۲؟» | “Vote: Version 1 or 2?”
«کدوم موضوع برای اپیزود بعد؟ A/B/C» | “Next topic? A/B/C.”
14) ریمیکس/دوئت/استیچ یا استفاده از صدا/تمپلیت (Remix/Duet/Stitch / Use Sound/Template)
هدف: UGC و هم‌آفرینی.
اصطکاک: متوسط | محل: داخل ویدئو/کپشن.
مثال‌ها:
«با همین صدا نتیجه خودتو نشون بده.» | “Use this sound and show your result.”
“Duet this with your version of the drill.”
15) UGC با هشتگ اختصاصی (Post with Our Hashtag)
هدف: موج محتوا، اثبات اجتماعی.
اصطکاک: متوسط | محل: داخل ویدئو/کپشن/تامنیل.
مثال‌ها:
«با هشتگ #X چالش رو اجرا کن؛ بهترین‌ها ری‌پُست می‌شن.» | “Post with #X—top entries get reposted.”
“Show us your setup using #XSetup.”
16) ثبت‌نام/عضویت (Sign Up / Register)
هدف: جمع‌آوری داده، لید.
اصطکاک: بالا | محل: کپشن/بیو/صفحهٔ مقصد.
توصیه: مشوق ملموس بده (تخفیف/مزیت/محتوای اختصاصی). SocialPilot
مثال‌ها:
«برای وبینار رایگان اسم بنویس—صندلی محدوده.» | “Register for the free webinar—limited seats.”
“Join the waitlist—early access only.”
17) دانلود منبع (Download Lead Magnet)
هدف: لید با ارزش پیشنهادی.
اصطکاک: بالا | محل: لینک/بیو/لندینگ.
مثال‌ها:
«چک‌لیست PDF رو از لینک بگیر.» | “Grab the PDF checklist via the link.”
“Download the sample pack—free.”
18) شروع دورهٔ آزمایشی (Start Free Trial)
هدف: تبدیل/آزمون ارزش محصول.
اصطکاک: بالا | محل: لینک/انداسکرین (یوتیوب)، کپشن.
مثال‌ها:
«۷ روز تست رایگان—الان فعالش کن.» | “Start your 7-day free trial now.”
“Try it free—no credit card.”
19) خرید/سفارش (Buy Now / Order)
هدف: تبدیل مستقیم.
اصطکاک: بالا | محل: لینک/بیو/شاپ تگ/اندکار.
مثال‌ها:
«الان سفارش بده—ارسال امروز.» | “Order now—ships today.”
“Buy now—limited stock.”
20) رزرو دمو/تماس (Book a Demo / Call)
هدف: فروش B2B/خدمات تخصصی.
اصطکاک: بالا | محل: لینک زمان‌بندی/DM.
مثال‌ها:
«برای دمو ۱۵‌دقیقه‌ای وقت بگیر.» | “Book a 15-min demo.”
“Schedule a call—see it in action.”
ماتریس ترکیب ایده‌ها
انتخاب دغدغه + تکنیک سناریو + فرم محتوا +CTA.
"""

# ---- روت‌های برنامه ----
@app.route('/')
def index():
    return render_template('index.html')

@app.route('/generate-concerns', methods=['POST'])
def generate_concerns():
    if not model:
        return jsonify({'error': 'مدل پیکربندی نشده است.'}), 500
    try:
        brand_info = request.json
        prompt = f"شما یک استراتژیست برند هستید. بر اساس بریف زیر، ۵ دغدغه اصلی مخاطبان را لیست کنید.\nبریف: {brand_info}"
        
        # --- کد جدید برای مدیریت پاسخ خالی ---
        response = model.generate_content(prompt)
        
        # این شرط بررسی می‌کند که آیا پاسخ به دلیل فیلترهای ایمنی خالی است یا خیر
        if not response.parts:
            # سعی می‌کنیم دلیل بلاک شدن را از فیدبک بگیریم
            try:
                block_reason = response.prompt_feedback.block_reason
                error_message = f"درخواست توسط فیلتر ایمنی مسدود شد. دلیل: {block_reason}. لطفا اطلاعات بیشتری در فرم وارد کنید."
            except Exception:
                error_message = "پاسخی از هوش مصنوعی دریافت نشد. ممکن است اطلاعات وارد شده بسیار کم باشد یا توسط فیلترهای ایمنی مسدود شده باشد. لطفا اطلاعات بیشتری در فرم وارد کنید."
            
            print(f"پاسخ خالی دریافت شد. دلیل احتمالی: {error_message}")
            return jsonify({'error': error_message}), 400
        
        return jsonify({'concerns': response.text})

    except Exception as e:
        traceback.print_exc()
        return jsonify({'error': f'خطای داخلی سرور: {str(e)}'}), 500

@app.route('/generate-scenario', methods=['POST'])
def generate_scenario():
    if not model:
        return jsonify({'error': 'مدل پیکربندی نشده است.'}), 500
    try:
        data = request.json
        brand_info = data['brandInfo']
        concerns = data['concerns']
        prompt = f"""
        شما یک کارگردان خلاق هستید. بر اساس اطلاعات زیر و با استفاده از پلی‌بوک، یک سناریو بنویسید.
        بریف: {brand_info}
        دغدغه‌ها: {concerns}
        پلی‌بوک: {CONTENT_PLAYBOOK}
        """
        response = model.generate_content(prompt)

        # --- کد جدید برای مدیریت پاسخ خالی ---
        if not response.parts:
            try:
                block_reason = response.prompt_feedback.block_reason
                error_message = f"درخواست توسط فیلتر ایمنی مسدود شد. دلیل: {block_reason}."
            except Exception:
                error_message = "پاسخی از هوش مصنوعی برای سناریو دریافت نشد."
            
            print(f"پاسخ خالی برای سناریو دریافت شد. دلیل احتمالی: {error_message}")
            return jsonify({'error': error_message}), 400

        return jsonify({'scenario': response.text})
    except Exception as e:
        traceback.print_exc()
        return jsonify({'error': f'خطای داخلی سرور: {str(e)}'}), 500

if __name__ == '__main__':
    app.run(debug=True)
